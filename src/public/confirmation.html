<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Participante</title>
    <style>
        body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(to right, #00ff7f, #32cd32);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    text-align: center;
}

.container {
    background-color: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    max-width: 450px;
    width: 90%;
    margin: 20px;
}

h1 {
    margin-bottom: 20px;
    color: #333;
    font-size: 24px;
    font-weight: 600;
}

#result-details {
    text-align: left; /* Alinhando o texto à esquerda */
    white-space: pre-wrap;
    margin-top: 20px;
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    color: #333;
    font-size: 16px;
    line-height: 1.5;
}

#qr-code {
    margin-top: 20px;
    max-width: 100%;
    height: auto;
    border: 2px solid #32cd32; /* Borda verde para combinar com o tema */
    border-radius: 8px;
    display: none;
    margin-left: auto;
    margin-right: auto;
}

.btn-back {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    color: #fff;
    background-color: #32cd32;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.btn-back:hover {
    background-color: #228b22;
}

#loading-text {
    font-size: 16px;
    color: #333;
    margin-top: 20px;
    display: none;
}

@media (max-width: 600px) {
    .container {
        padding: 15px;
        margin: 10px;
        width: 100%;
        box-shadow: none;
    }

    h1 {
        font-size: 22px;
    }

    #result-details {
        font-size: 14px;
        padding: 10px;
    }

    .btn-back {
        padding: 10px 15px;
        font-size: 14px;
    }
}
    </style>
</head>

<body>
    <div class="container">
        <h1>Detalhes do Participante</h1>
        <div id="result-details">Carregando dados...</div>
        <p id="loading-text">Carregando QR Code...</p>
        <img id="qr-code" alt="QR Code">
        <a href="register.html" class="btn-back">Voltar para Registro</a>
        <button id="btn-save" class="btn-save">Salvar como PDF</button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const participantId = urlParams.get('id');

            if (participantId) {
                try {
                    console.log(`Buscando dados para o participante com ID: ${participantId}`);

                    const response = await fetch(`https://backend-teste-ebiv.onrender.com/api/participants/${participantId}`);

                    if (!response.ok) {
                        throw new Error(`Erro HTTP! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('Resposta da API:', result);

                    if (result && result.participant) {
                        const participant = result.participant;
                        const detailsElement = document.getElementById('result-details');

                        const birthDate = new Date(participant.birthDate);
                        const formattedBirthDate = birthDate.toLocaleDateString('pt-BR');

                        detailsElement.innerHTML = `
                            <strong>Nome:</strong> ${participant.name}<br>
                            <strong>Data de Nascimento:</strong> ${formattedBirthDate}<br>
                            <strong>CPF:</strong> ${participant.cpf}<br>
                            <strong>Igreja:</strong> ${participant.church}<br>
                            <strong>Distrito:</strong> ${participant.district}<br>
                            <strong>WhatsApp:</strong> ${participant.whatsapp}<br>
                        `;

                        const qrCodeElement = document.getElementById('qr-code');
                        const loadingText = document.getElementById('loading-text');
                        loadingText.style.display = 'block';

                        const qrCodeResponse = await fetch(`https://backend-teste-ebiv.onrender.com/api/participants/${participantId}/qrcode`);

                        if (!qrCodeResponse.ok) {
                            throw new Error(`Erro HTTP! status: ${qrCodeResponse.status}`);
                        }

                        const qrCodeResult = await qrCodeResponse.json();
                        console.log('Resposta da API do QR Code:', qrCodeResult);

                        if (qrCodeResult && qrCodeResult.qrCode) {
                            qrCodeElement.src = qrCodeResult.qrCode;
                            qrCodeElement.style.display = 'block';
                        } else {
                            throw new Error('QR Code não encontrado.');
                        }

                        loadingText.style.display = 'none';
                    } else {
                        throw new Error('Dados do participante não encontrados.');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    document.getElementById('result-details').textContent = 'Erro ao carregar os dados do participante.';
                    document.getElementById('loading-text').style.display = 'none';
                    document.getElementById('qr-code').style.display = 'none';
                }
            } else {
                document.getElementById('result-details').textContent = 'ID do participante não fornecido.';
                document.getElementById('loading-text').style.display = 'none';
                document.getElementById('qr-code').style.display = 'none';
            }

            // Função para salvar como PDF
            document.getElementById('btn-save').addEventListener('click', () => {
                const element = document.querySelector('.container');
                const opt = {
                    margin: 1,
                    filename: `comprovante_${participantId}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                html2pdf().from(element).set(opt).save();
            });
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</body>

</html>
